<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refer & Earn - EARNZY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #0ea5a4 100%); }
        .bottom-nav { box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <a href="dashboard.html" class="text-white">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-xl font-bold">Refer & Earn</h1>
            </div>
            <div class="flex items-center space-x-2 bg-green-700 bg-opacity-50 px-3 py-1 rounded-lg">
                <i class="fas fa-coins text-yellow-300"></i>
                <span id="userBalance" class="font-medium">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 pb-20">
        <!-- Referral Stats -->
        <div class="bg-white rounded-2xl p-6 shadow-md mb-6 text-center">
            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-users text-white text-2xl"></i>
            </div>
            
            <h2 class="text-xl font-bold text-gray-800 mb-2">Refer Friends & Earn</h2>
            <p class="text-gray-600 mb-6">Earn 20% of your friends' earnings for their first month</p>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="referralCount">0</div>
                    <div class="text-sm text-gray-500">Referred</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="activeReferrals">0</div>
                    <div class="text-sm text-gray-500">Active</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="referralEarnings">₹0</div>
                    <div class="text-sm text-gray-500">Earned</div>
                </div>
            </div>

            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-center space-x-2 text-green-700 mb-2">
                    <i class="fas fa-gift"></i>
                    <span class="font-medium">Referral Bonus: ₹20 per friend</span>
                </div>
                <div class="text-sm text-green-600">
                    Your friend gets ₹2 signup bonus + you earn 20% of their first month earnings
                </div>
            </div>
        </div>

        <!-- Referral Code -->
        <div class="bg-white rounded-2xl p-6 shadow-md mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Your Referral Code</h3>
            
            <div class="bg-gradient-to-r from-green-400 to-green-600 rounded-xl p-4 text-center text-white mb-4">
                <div class="text-sm mb-2">Share this code with friends</div>
                <div id="referralCode" class="text-2xl font-bold tracking-widest mb-2">LOADING...</div>
                <button 
                    id="copyCodeBtn"
                    class="bg-white text-green-600 px-4 py-2 rounded-lg font-medium hover:bg-green-50 transition"
                >
                    <i class="fas fa-copy mr-2"></i>Copy Code
                </button>
            </div>

            <div class="text-center text-sm text-gray-600">
                Or share your referral link directly
            </div>
        </div>

        <!-- Share Options -->
        <div class="bg-white rounded-2xl p-6 shadow-md mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Share Via</h3>
            
            <div class="grid grid-cols-4 gap-3">
                <button class="share-btn bg-blue-500 text-white p-3 rounded-xl flex flex-col items-center justify-center hover:bg-blue-600 transition">
                    <i class="fab fa-whatsapp text-xl mb-1"></i>
                    <span class="text-xs">WhatsApp</span>
                </button>
                <button class="share-btn bg-blue-400 text-white p-3 rounded-xl flex flex-col items-center justify-center hover:bg-blue-500 transition">
                    <i class="fab fa-telegram text-xl mb-1"></i>
                    <span class="text-xs">Telegram</span>
                </button>
                <button class="share-btn bg-gray-800 text-white p-3 rounded-xl flex flex-col items-center justify-center hover:bg-gray-900 transition">
                    <i class="fab fa-instagram text-xl mb-1"></i>
                    <span class="text-xs">Instagram</span>
                </button>
                <button class="share-btn bg-green-500 text-white p-3 rounded-xl flex flex-col items-center justify-center hover:bg-green-600 transition">
                    <i class="fas fa-sms text-xl mb-1"></i>
                    <span class="text-xs">SMS</span>
                </button>
            </div>

            <div class="mt-4 text-center">
                <button 
                    id="shareLinkBtn"
                    class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 transition flex items-center justify-center space-x-2"
                >
                    <i class="fas fa-share-alt"></i>
                    <span>Generate Shareable Link</span>
                </button>
            </div>
        </div>

        <!-- Referral History -->
        <div class="bg-white rounded-2xl p-6 shadow-md">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Referral History</h3>
            <div id="referralHistory" class="space-y-3">
                <!-- History will be loaded here -->
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-users text-3xl mb-3 opacity-50"></i>
                    <div class="font-medium text-gray-600 mb-2">No referrals yet</div>
                    <div class="text-sm">Start sharing your referral code to earn rewards</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Share Link Modal -->
    <div id="shareLinkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Share Referral Link</h3>
                    <button onclick="closeShareModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Referral Link</label>
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="referralLink"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-gray-50"
                            readonly
                        >
                        <button 
                            id="copyLinkBtn"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition"
                        >
                            Copy
                        </button>
                    </div>
                </div>

                <div class="text-sm text-gray-600">
                    Share this link with your friends. When they sign up using this link, you'll earn referral bonuses!
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
        <div class="flex justify-around items-center py-3">
            <a href="dashboard.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-xs">Home</span>
            </a>
            <a href="tasks.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-tasks text-xl mb-1"></i>
                <span class="text-xs">Tasks</span>
            </a>
            <a href="referrals.html" class="flex flex-col items-center text-green-600">
                <i class="fas fa-users text-xl mb-1"></i>
                <span class="text-xs">Referrals</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-xs">Profile</span>
            </a>
        </div>
    </nav>

    <!-- Scripts -->
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script>
        class ReferralManager {
            constructor() {
                this.userProfile = null;
                this.referralHistory = [];
                this.init();
            }

            async init() {
                await this.checkAuth();
                await this.loadReferralData();
                this.setupEventListeners();
            }

            async checkAuth() {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                this.userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                this.updateBalance();
                this.generateReferralCode();
            }

            updateBalance() {
                document.getElementById('userBalance').textContent = `₹${this.userProfile.balance || '0.00'}`;
            }

            generateReferralCode() {
                // Generate referral code from user ID
                const code = 'EARNZY' + this.userProfile.id.substring(0, 8).toUpperCase();
                document.getElementById('referralCode').textContent = code;
                
                // Generate referral link
                const link = `${window.location.origin}/login.html?ref=${code}`;
                document.getElementById('referralLink').value = link;
            }

            async loadReferralData() {
                // Load referral count
                const { data: referrals, error } = await supabase
                    .from('referrals')
                    .select('*')
                    .eq('referrer_id', this.userProfile.id);

                if (!error && referrals) {
                    document.getElementById('referralCount').textContent = referrals.length;
                    
                    // Calculate active referrals (last 30 days)
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const activeRefs = referrals.filter(ref => 
                        new Date(ref.created_at) > thirtyDaysAgo
                    );
                    document.getElementById('activeReferrals').textContent = activeRefs.length;

                    // Load referral earnings
                    await this.loadReferralEarnings();
                }

                // Load referral history
                await this.loadReferralHistory();
            }

            async loadReferralEarnings() {
                const { data: earnings, error } = await supabase
                    .from('transactions')
                    .select('amount')
                    .eq('user_id', this.userProfile.id)
                    .eq('type', 'referral_bonus');

                if (!error && earnings) {
                    const totalEarnings = earnings.reduce((sum, e) => sum + e.amount, 0);
                    document.getElementById('referralEarnings').textContent = `₹${totalEarnings}`;
                }
            }

            async loadReferralHistory() {
                const { data: referrals, error } = await supabase
                    .from('referrals')
                    .select(`
                        *,
                        referred_user:users!referrals_referred_id_fkey(full_name, email, created_at)
                    `)
                    .eq('referrer_id', this.userProfile.id)
                    .order('created_at', { ascending: false });

                if (!error && referrals) {
                    this.referralHistory = referrals;
                    this.renderReferralHistory();
                }
            }

            renderReferralHistory() {
                const container = document.getElementById('referralHistory');
                
                if (this.referralHistory.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-users text-3xl mb-3 opacity-50"></i>
                            <div class="font-medium text-gray-600 mb-2">No referrals yet</div>
                            <div class="text-sm">Start sharing your referral code to earn rewards</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.referralHistory.map(ref => `
                    <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-green-600"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">
                                    ${ref.referred_user?.full_name || 'New User'}
                                </div>
                                <div class="text-xs text-gray-500">
                                    Joined ${this.formatDate(ref.created_at)}
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold ${ref.bonus_paid ? 'text-green-600' : 'text-yellow-600'}">
                                ${ref.bonus_paid ? '₹20' : 'Pending'}
                            </div>
                            <div class="text-xs text-gray-500">
                                ${ref.bonus_paid ? 'Bonus Paid' : 'Awaiting Activity'}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            setupEventListeners() {
                // Copy referral code
                document.getElementById('copyCodeBtn').addEventListener('click', () => {
                    this.copyToClipboard(document.getElementById('referralCode').textContent);
                    this.showToast('Referral code copied!');
                });

                // Copy referral link
                document.getElementById('copyLinkBtn').addEventListener('click', () => {
                    this.copyToClipboard(document.getElementById('referralLink').value);
                    this.showToast('Referral link copied!');
                });

                // Share buttons
                document.querySelectorAll('.share-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const platform = e.currentTarget.querySelector('span').textContent.toLowerCase();
                        this.shareReferral(platform);
                    });
                });

                // Share link modal
                document.getElementById('shareLinkBtn').addEventListener('click', () => {
                    document.getElementById('shareLinkModal').classList.remove('hidden');
                });
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    console.log('Text copied to clipboard');
                }).catch(err => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                });
            }

            shareReferral(platform) {
                const message = `Join EARNZY and start earning real money! Use my referral code: ${document.getElementById('referralCode').textContent} - ${document.getElementById('referralLink').value}`;
                
                let shareUrl = '';
                
                switch (platform) {
                    case 'whatsapp':
                        shareUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                        break;
                    case 'telegram':
                        shareUrl = `https://t.me/share/url?url=${encodeURIComponent(document.getElementById('referralLink').value)}&text=${encodeURIComponent('Join EARNZY with my referral code!')}`;
                        break;
                    case 'instagram':
                        // Instagram doesn't have direct sharing, show message
                        this.copyToClipboard(message);
                        this.showToast('Referral message copied! Share it on Instagram');
                        return;
                    case 'sms':
                        shareUrl = `sms:?body=${encodeURIComponent(message)}`;
                        break;
                }

                if (shareUrl) {
                    window.open(shareUrl, '_blank');
                }
            }

            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 1) return 'yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
                return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
            }
        }

        function closeShareModal() {
            document.getElementById('shareLinkModal').classList.add('hidden');
        }

        // Initialize referral manager
        document.addEventListener('DOMContentLoaded', () => {
            new ReferralManager();
        });
    </script>
</body>
</html>

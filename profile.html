<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - EARNZY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #0ea5a4 100%); }
        .bottom-nav { box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <a href="dashboard.html" class="text-white">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-xl font-bold">Profile</h1>
            </div>
            <div class="flex items-center space-x-2 bg-green-700 bg-opacity-50 px-3 py-1 rounded-lg">
                <i class="fas fa-coins text-yellow-300"></i>
                <span id="userBalance" class="font-medium">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 pb-20">
        <!-- Profile Card -->
        <div class="bg-white rounded-2xl p-6 shadow-md mb-6 text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-user text-white text-2xl"></i>
            </div>
            
            <h2 id="userName" class="text-xl font-bold text-gray-800 mb-1">Loading...</h2>
            <p id="userEmail" class="text-gray-600 mb-4">Loading...</p>
            
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <div class="font-bold text-gray-800 text-lg" id="profileBalance">₹0</div>
                    <div class="text-xs text-gray-500">Balance</div>
                </div>
                <div>
                    <div class="font-bold text-gray-800 text-lg" id="totalEarned">₹0</div>
                    <div class="text-xs text-gray-500">Total Earned</div>
                </div>
                <div>
                    <div class="font-bold text-gray-800 text-lg" id="memberSince">0d</div>
                    <div class="text-xs text-gray-500">Member</div>
                </div>
            </div>
        </div>

        <!-- Account Information -->
        <div class="bg-white rounded-2xl p-6 shadow-md mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Account Information</h2>
            
            <div class="space-y-4">
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-id-card text-blue-600 text-sm"></i>
                        </div>
                        <span class="text-gray-600">User ID</span>
                    </div>
                    <span id="userId" class="font-medium text-gray-800 text-sm">Loading...</span>
                </div>

                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-crown text-green-600 text-sm"></i>
                        </div>
                        <span class="text-gray-600">Plan</span>
                    </div>
                    <span id="userPlan" class="font-medium text-green-600">Free</span>
                </div>

                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar text-purple-600 text-sm"></i>
                        </div>
                        <span class="text-gray-600">Joined</span>
                    </div>
                    <span id="joinDate" class="font-medium text-gray-800">Loading...</span>
                </div>

                <div class="flex justify-between items-center py-2">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-mobile text-yellow-600 text-sm"></i>
                        </div>
                        <span class="text-gray-600">Device</span>
                    </div>
                    <span id="deviceId" class="font-medium text-gray-800 text-sm">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="bg-white rounded-2xl p-6 shadow-md mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Earning Stats</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-tasks text-green-600"></i>
                    </div>
                    <div class="font-bold text-gray-800 text-lg" id="tasksCompleted">0</div>
                    <div class="text-xs text-gray-500">Tasks Done</div>
                </div>

                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-tv text-blue-600"></i>
                    </div>
                    <div class="font-bold text-gray-800 text-lg" id="adsWatched">0</div>
                    <div class="text-xs text-gray-500">Ads Watched</div>
                </div>

                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-calendar-check text-yellow-600"></i>
                    </div>
                    <div class="font-bold text-gray-800 text-lg" id="checkinStreak">0</div>
                    <div class="text-xs text-gray-500">Day Streak</div>
                </div>

                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-users text-purple-600"></i>
                    </div>
                    <div class="font-bold text-gray-800 text-lg" id="referralsCount">0</div>
                    <div class="text-xs text-gray-500">Referrals</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-2xl p-6 shadow-md">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h2>
            
            <div class="space-y-3">
                <a href="subscriptions.html" class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center group-hover:bg-yellow-200 transition">
                            <i class="fas fa-crown text-yellow-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">Upgrade Plan</div>
                            <div class="text-sm text-gray-500">Get higher rewards & instant withdrawals</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 transition"></i>
                </a>

                <a href="support.html" class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition">
                            <i class="fas fa-headset text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">Support</div>
                            <div class="text-sm text-gray-500">Get help from our support team</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 transition"></i>
                </a>

                <a href="#" class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition">
                            <i class="fas fa-shield-alt text-green-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">Privacy & Security</div>
                            <div class="text-sm text-gray-500">Manage your account security</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 transition"></i>
                </a>

                <button onclick="profileManager.logout()" class="w-full flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition group text-left">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center group-hover:bg-red-200 transition">
                            <i class="fas fa-sign-out-alt text-red-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-800">Logout</div>
                            <div class="text-sm text-gray-500">Sign out from your account</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 transition"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
        <div class="flex justify-around items-center py-3">
            <a href="dashboard.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-xs">Home</span>
            </a>
            <a href="tasks.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-tasks text-xl mb-1"></i>
                <span class="text-xs">Tasks</span>
            </a>
            <a href="withdraw.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-wallet text-xl mb-1"></i>
                <span class="text-xs">Withdraw</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center text-green-600">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-xs">Profile</span>
            </a>
        </div>
    </nav>

    <!-- Scripts -->
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script>
        class ProfileManager {
            constructor() {
                this.userProfile = null;
                this.init();
            }

            async init() {
                await this.checkAuth();
                await this.loadProfileData();
                await this.loadStats();
            }

            async checkAuth() {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                this.userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                this.updateBalance();
                this.updateProfileInfo();
            }

            updateBalance() {
                document.getElementById('userBalance').textContent = `₹${this.userProfile.balance || '0.00'}`;
                document.getElementById('profileBalance').textContent = `₹${this.userProfile.balance || '0.00'}`;
            }

            updateProfileInfo() {
                // User name and email
                const userName = this.userProfile.full_name || 'User';
                const userEmail = this.userProfile.email || 'No email';
                
                document.getElementById('userName').textContent = userName;
                document.getElementById('userEmail').textContent = userEmail;

                // User ID
                document.getElementById('userId').textContent = this.userProfile.id?.substring(0, 8) + '...' || 'Unknown';

                // Plan
                const plan = this.userProfile.subscription_plan || 'free';
                const planNames = {
                    free: 'Free',
                    silver: 'Silver',
                    gold: 'Gold',
                    platinum: 'Platinum'
                };
                document.getElementById('userPlan').textContent = planNames[plan];

                // Join date
                if (this.userProfile.created_at) {
                    const joinDate = new Date(this.userProfile.created_at);
                    const now = new Date();
                    const diffTime = Math.abs(now - joinDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    document.getElementById('joinDate').textContent = joinDate.toLocaleDateString('en-IN');
                    document.getElementById('memberSince').textContent = `${diffDays}d`;
                }

                // Device ID
                document.getElementById('deviceId').textContent = this.userProfile.device_id?.substring(0, 8) + '...' || 'Unknown';

                // Total earned
                document.getElementById('totalEarned').textContent = `₹${this.userProfile.total_earned || '0.00'}`;
            }

            async loadStats() {
                // Load tasks completed
                const { data: tasks, error: tasksError } = await supabase
                    .from('task_submissions')
                    .select('id')
                    .eq('user_id', this.userProfile.id)
                    .eq('status', 'approved');

                if (!tasksError) {
                    document.getElementById('tasksCompleted').textContent = tasks?.length || 0;
                }

                // Load ads watched
                const { data: ads, error: adsError } = await supabase
                    .from('transactions')
                    .select('id')
                    .eq('user_id', this.userProfile.id)
                    .eq('type', 'ad_reward');

                if (!adsError) {
                    document.getElementById('adsWatched').textContent = ads?.length || 0;
                }

                // Load check-in streak (simplified)
                const { data: checkins, error: checkinError } = await supabase
                    .from('transactions')
                    .select('created_at')
                    .eq('user_id', this.userProfile.id)
                    .eq('type', 'daily_checkin')
                    .order('created_at', { ascending: false });

                if (!checkinError && checkins) {
                    const streak = this.calculateStreak(checkins);
                    document.getElementById('checkinStreak').textContent = streak;
                }

                // Load referrals count
                const { data: referrals, error: refError } = await supabase
                    .from('referrals')
                    .select('id')
                    .eq('referrer_id', this.userProfile.id);

                if (!refError) {
                    document.getElementById('referralsCount').textContent = referrals?.length || 0;
                }
            }

            calculateStreak(checkins) {
                if (checkins.length === 0) return 0;

                let streak = 0;
                const today = new Date();
                let currentDate = new Date(today);

                for (let i = 0; i < 30; i++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const hasCheckin = checkins.some(c => 
                        c.created_at.split('T')[0] === dateStr
                    );

                    if (hasCheckin) {
                        streak++;
                        currentDate.setDate(currentDate.getDate() - 1);
                    } else {
                        break;
                    }
                }

                return streak;
            }

            async loadProfileData() {
                // Refresh user data from server
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', this.userProfile.id)
                    .single();

                if (!error && user) {
                    this.userProfile = user;
                    localStorage.setItem('userProfile', JSON.stringify(user));
                    this.updateProfileInfo();
                    this.updateBalance();
                }
            }

            logout() {
                if (confirm('Are you sure you want to logout?')) {
                    authManager.logout();
                }
            }
        }

        const profileManager = new ProfileManager();
    </script>
</body>
</html>

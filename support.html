<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support - EARNZY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #0ea5a4 100%); }
        .bottom-nav { box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px); }
        .message-self { 
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: white;
            margin-left: auto;
        }
        .message-other {
            background: #f3f4f6;
            color: #374151;
            margin-right: auto;
        }
        .chat-container {
            height: 60vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <a href="dashboard.html" class="text-white">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-xl font-bold">Support</h1>
            </div>
            <div class="flex items-center space-x-2 bg-green-700 bg-opacity-50 px-3 py-1 rounded-lg">
                <i class="fas fa-headset"></i>
                <span class="font-medium">Online</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 pb-20">
        <!-- Chat Container -->
        <div class="bg-white rounded-2xl shadow-md flex flex-col h-[70vh]">
            <!-- Chat Header -->
            <div class="border-b border-gray-200 p-4">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-headset text-green-600"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">EARNZY Support</div>
                        <div class="text-xs text-green-600 flex items-center space-x-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span>Online - Usually replies in minutes</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div id="messagesContainer" class="chat-container flex-1 p-4 space-y-4">
                <!-- Welcome Message -->
                <div class="message-other max-w-xs lg:max-w-md rounded-2xl p-3">
                    <div class="font-medium text-sm mb-1">EARNZY Support</div>
                    <div class="text-sm">Hello! ðŸ‘‹ How can I help you today? You can ask me about:</div>
                    <ul class="text-sm mt-2 space-y-1">
                        <li>â€¢ Task verification issues</li>
                        <li>â€¢ Withdrawal problems</li>
                        <li>â€¢ Account related queries</li>
                        <li>â€¢ Payment methods</li>
                    </ul>
                    <div class="text-xs text-gray-500 mt-2">Just type your question below</div>
                </div>

                <!-- Messages will be loaded here -->
            </div>

            <!-- Message Input -->
            <div class="border-t border-gray-200 p-4">
                <div class="flex space-x-3">
                    <input 
                        type="text" 
                        id="messageInput"
                        placeholder="Type your message..."
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                        maxlength="500"
                    >
                    <button 
                        id="sendMessageBtn"
                        class="bg-green-600 text-white w-12 h-12 rounded-full flex items-center justify-center hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="text-xs text-gray-500 text-center mt-2">
                    Our support team is available 24/7 to help you
                </div>
            </div>
        </div>

        <!-- Quick Questions -->
        <div class="mt-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Frequently Asked Questions</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <button class="quick-question bg-white rounded-lg p-4 shadow-sm text-left hover:bg-gray-50 transition border border-gray-200">
                    <div class="font-medium text-gray-800 mb-1">How long does task verification take?</div>
                    <div class="text-sm text-gray-600">Task verification usually takes 1-6 hours during business days.</div>
                </button>

                <button class="quick-question bg-white rounded-lg p-4 shadow-sm text-left hover:bg-gray-50 transition border border-gray-200">
                    <div class="font-medium text-gray-800 mb-1">When will I receive my withdrawal?</div>
                    <div class="text-sm text-gray-600">Free users: 24-48 hours | Premium users: Instant</div>
                </button>

                <button class="quick-question bg-white rounded-lg p-4 shadow-sm text-left hover:bg-gray-50 transition border border-gray-200">
                    <div class="font-medium text-gray-800 mb-1">Why was my task rejected?</div>
                    <div class="text-sm text-gray-600">Common reasons: blurry screenshot, incomplete task, wrong proof submitted.</div>
                </button>

                <button class="quick-question bg-white rounded-lg p-4 shadow-sm text-left hover:bg-gray-50 transition border border-gray-200">
                    <div class="font-medium text-gray-800 mb-1">How do I upgrade my plan?</div>
                    <div class="text-sm text-gray-600">Go to Profile â†’ Upgrade Plan to choose from Silver, Gold, or Platinum.</div>
                </button>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="bg-white rounded-2xl p-6 shadow-md mt-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Other Ways to Contact Us</h2>
            <div class="space-y-3">
                <div class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-envelope text-blue-600"></i>
                    </div>
                    <div>
                        <div class="font-medium text-gray-800">Email Support</div>
                        <div class="text-sm text-gray-600">support@earnzy.in</div>
                    </div>
                </div>

                <div class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fab fa-whatsapp text-green-600"></i>
                    </div>
                    <div>
                        <div class="font-medium text-gray-800">WhatsApp</div>
                        <div class="text-sm text-gray-600">+91 98765 43210</div>
                    </div>
                </div>

                <div class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-phone text-purple-600"></i>
                    </div>
                    <div>
                        <div class="font-medium text-gray-800">Phone Support</div>
                        <div class="text-sm text-gray-600">Available for premium users</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
        <div class="flex justify-around items-center py-3">
            <a href="dashboard.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-xs">Home</span>
            </a>
            <a href="tasks.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-tasks text-xl mb-1"></i>
                <span class="text-xs">Tasks</span>
            </a>
            <a href="support.html" class="flex flex-col items-center text-green-600">
                <i class="fas fa-headset text-xl mb-1"></i>
                <span class="text-xs">Support</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center text-gray-500">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-xs">Profile</span>
            </a>
        </div>
    </nav>

    <!-- Scripts -->
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script>
        class SupportManager {
            constructor() {
                this.userProfile = null;
                this.messages = [];
                this.adminId = 'admin'; // In real app, this would be actual admin ID
                this.init();
            }

            async init() {
                await this.checkAuth();
                await this.loadMessages();
                this.setupEventListeners();
                this.setupRealtimeListener();
            }

            async checkAuth() {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                
                this.userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            }

            async loadMessages() {
                const { data: messages, error } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .or(`sender_id.eq.${this.userProfile.id},receiver_id.eq.${this.userProfile.id}`)
                    .order('created_at', { ascending: true });

                if (!error && messages) {
                    this.messages = messages;
                    this.renderMessages();
                    this.scrollToBottom();
                }
            }

            renderMessages() {
                const container = document.getElementById('messagesContainer');
                
                // Keep the welcome message
                const welcomeMessage = container.querySelector('.message-other');
                container.innerHTML = '';
                if (welcomeMessage) {
                    container.appendChild(welcomeMessage);
                }

                // Render all messages
                this.messages.forEach(message => {
                    const messageElement = this.createMessageElement(message);
                    container.appendChild(messageElement);
                });

                this.scrollToBottom();
            }

            createMessageElement(message) {
                const isOwnMessage = message.sender_id === this.userProfile.id;
                const messageDiv = document.createElement('div');
                
                messageDiv.className = `max-w-xs lg:max-w-md rounded-2xl p-3 ${isOwnMessage ? 'message-self' : 'message-other'}`;
                
                const time = new Date(message.created_at).toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                messageDiv.innerHTML = `
                    <div class="font-medium text-sm mb-1 ${isOwnMessage ? 'text-green-100' : 'text-gray-800'}">
                        ${isOwnMessage ? 'You' : 'EARNZY Support'}
                    </div>
                    <div class="text-sm ${isOwnMessage ? 'text-white' : 'text-gray-700'}">${message.message}</div>
                    <div class="text-xs ${isOwnMessage ? 'text-green-100' : 'text-gray-500'} mt-1 text-right">${time}</div>
                `;

                return messageDiv;
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();

                if (!message) return;

                const sendBtn = document.getElementById('sendMessageBtn');
                sendBtn.disabled = true;

                try {
                    // Create message object
                    const newMessage = {
                        sender_id: this.userProfile.id,
                        receiver_id: this.adminId,
                        message: message,
                        is_read: false,
                        created_at: new Date().toISOString()
                    };

                    // Insert message into database
                    const { data, error } = await supabase
                        .from('chat_messages')
                        .insert([newMessage]);

                    if (error) throw error;

                    // Add to local messages and render
                    this.messages.push(newMessage);
                    this.renderMessages();

                    // Clear input
                    messageInput.value = '';

                    // Simulate auto-reply for demo
                    setTimeout(() => {
                        this.sendAutoReply(message);
                    }, 2000);

                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Error sending message: ' + error.message);
                } finally {
                    sendBtn.disabled = false;
                }
            }

            async sendAutoReply(userMessage) {
                let replyMessage = '';

                // Simple auto-reply based on keywords
                if (userMessage.toLowerCase().includes('task') && userMessage.toLowerCase().includes('verify')) {
                    replyMessage = 'Task verification usually takes 1-6 hours. Our team manually checks each submission to ensure quality. If your task is taking longer, please share the task ID and I\'ll check the status.';
                } else if (userMessage.toLowerCase().includes('withdraw') || userMessage.toLowerCase().includes('payment')) {
                    replyMessage = 'Withdrawal processing times: Free users: 24-48 hours, Premium users: Instant. Minimum withdrawal is â‚¹25 with a â‚¹2 fee. Daily limit is â‚¹150.';
                } else if (userMessage.toLowerCase().includes('refer') || userMessage.toLowerCase().includes('friend')) {
                    replyMessage = 'You can refer friends and earn 20% of their first month earnings! Share your referral code from the Referrals section. Your friend gets â‚¹2 signup bonus too!';
                } else if (userMessage.toLowerCase().includes('plan') || userMessage.toLowerCase().includes('upgrade')) {
                    replyMessage = 'Upgrading your plan gives you higher rewards and faster withdrawals. Silver: +20% tasks, Gold: +30% tasks + instant withdrawals, Platinum: +50% tasks + VIP features.';
                } else {
                    replyMessage = 'Thank you for your message! Our support team will respond to you shortly. In the meantime, you can check our FAQ section for quick answers to common questions.';
                }

                const autoReply = {
                    sender_id: this.adminId,
                    receiver_id: this.userProfile.id,
                    message: replyMessage,
                    is_read: false,
                    created_at: new Date().toISOString()
                };

                try {
                    const { data, error } = await supabase
                        .from('chat_messages')
                        .insert([autoReply]);

                    if (!error) {
                        this.messages.push(autoReply);
                        this.renderMessages();
                    }
                } catch (error) {
                    console.error('Error sending auto-reply:', error);
                }
            }

            setupEventListeners() {
                // Send message on button click
                document.getElementById('sendMessageBtn').addEventListener('click', () => {
                    this.sendMessage();
                });

                // Send message on Enter key
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                // Quick question buttons
                document.querySelectorAll('.quick-question').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const question = e.currentTarget.querySelector('.font-medium').textContent;
                        document.getElementById('messageInput').value = question;
                        this.sendMessage();
                    });
                });
            }

            setupRealtimeListener() {
                // Listen for new messages in real-time
                supabase
                    .channel('chat_messages')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'chat_messages',
                            filter: `receiver_id=eq.${this.userProfile.id}`
                        }, 
                        (payload) => {
                            this.messages.push(payload.new);
                            this.renderMessages();
                        }
                    )
                    .subscribe();
            }

            scrollToBottom() {
                const container = document.getElementById('messagesContainer');
                container.scrollTop = container.scrollHeight;
            }
        }

        // Initialize support manager
        document.addEventListener('DOMContentLoaded', () => {
            new SupportManager();
        });
    </script>
</body>
</html>
